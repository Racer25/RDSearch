global.__base = __dirname + '/../../';

//Modules
var http = require('http');
var fs = require('fs');
var CronJob = require('cron').CronJob;
var NcbiApi = require('ncbi-entrez-api');
var async = require("async");

//My modules
var RareDisease = require("../model/RareDisease.js");
var TextualInformation = require("../model/TextualInformation.js");
var RareDisease_Year = require("../model/RareDisease_Year.js");

var ConnectionProvider=require("../dao/ConnectionProvider.js");
var OtherDao = require("../dao/OtherDao.js");
var TextualInformationDao = require("../dao/TextualInformationDao.js");
var RareDiseaseDao = require("../dao/RareDiseaseDao.js");
var RareDisease_YearDao = require("../dao/RareDisease_YearDao.js");
var YearDao = require("../dao/YearDao.js");

//Create the job
var job = new CronJob(
    {
        cronTime: '00 09 15* * 1-7',
        onTick: function() 
        {
            //Runs every weekday (Monday through Friday)
            //at 16:24:00 AM. It does not run on Saturday
            //or Sunday.
            download("http://www.orphadata.org/data/export/en_product1.json",__base+"download/en_product1.json", updateDB);
        },
        start: true,
        timeZone: 'America/Montreal'
    });

//Launch the Job!
job.start();


var updateDB = function()
{
    //First, we check the update date of orphanet file
    checkLastUpdateDate(updateRareDiseaseWorkflow, noUpdateRareDiseaseWorkflow);
};

var updateRareDiseaseWorkflow = function()
{
    //Connection to DB
    //ConnectionProvider.getConnection();
    //ConnectionProvider.connect();


    var diseases=[];
    var textualinformations=[];
    getInformationFromJSON(diseases, textualinformations);

    console.info("Updating of rarediseaseTable start...");
    async.each(
        diseases,
        function(disease, next)
        {
            RareDiseaseDao.addOrModifyRareDisease(disease, next);
        },
        function(err)
        {
            if(err)
            {
                console.error("Error occured updating rarediseases Table");
            }
            else
            {
                console.info("Update of rarediseaseTable finished at "+(new Date()).toISOString());
                console.info("Updating of TextualInformation start...");
                async.each(
                    textualinformations,
                    function(textualinformation, next)
                    {
                        console.log();
                        TextualInformationDao.addOrModifyTextualInformationFromOrphanet(textualinformation, next);
                    },
                    function(err)
                    {
                        if(err)
                        {
                            console.error("Error occured updating TextualInformation Table");
                            noUpdateRareDiseaseWorkflow();
                        }
                        else
                        {
                            console.info("Update of TextualInformation finished at "+(new Date()).toISOString());
                            noUpdateRareDiseaseWorkflow();
                        }
                    }
                );
            }
        }
    );
};

var noUpdateRareDiseaseWorkflow = function()
{
    //Connection to DB
    //ConnectionProvider.getConnection();
    //ConnectionProvider.connect();
    RareDiseaseDao.getRareDiseases(
        //Called when we received all diseases in results
        function(results)
        {
            console.info("Update of numberOfPublications start...");
            async.eachLimit(
                results, 
                3,
                //Called for each disease
                function (rareDisease, next) {
                    setTimeout(
                        //Called 3 times per second
                        function() 
                        {
                            console.log("Recherche maladie:{"+rareDisease.orphanetID+", "+rareDisease.name+"}");
                            getIdsFromSearch(
                                rareDisease.name, 
                                rareDisease.orphanetID, 
                                //Called when esearch finished and ids acquired
                                function(idlist, orphanetID)
                                {
                                    console.log("Scan articles de la maladie:{"+orphanetID+"}");
                                    getRareDisease_YearFromIds(
                                        idlist, 
                                        orphanetID,
                                        function(rareDisease_YearList)
                                        {
                                            async.eachLimit(
                                                rareDisease_YearList, 
                                                10,
                                                //Called for each rareDisease_Year
                                                function(rareDisease_Year, next2)
                                                {
                                                    var year=
                                                        {
                                                            year:rareDisease_Year.year,
                                                            numberOfPublications:0
                                                        };
                                                    YearDao.addOrModifyYear(
                                                        year,
                                                        function()
                                                        {
                                                            RareDisease_YearDao.addOrModifyRareDisease_Year(rareDisease_Year, next2);
                                                        }
                                                    );
                                                }
                                                ,
                                                function(err)
                                                {
                                                    if(err)
                                                    {
                                                        console.error("Error occured updating is_studied_during");
                                                    }
                                                    else
                                                    {
                                                        //console.info("Update of numberOfPublications finished");
                                                    }
                                                }
                                            );
                                        }
                                    );
                                    next();
                                }
                            );
                        }, 
                        1000);
                }, 
                function (err) 
                {
                    if(err)
                    {
                        console.error("Error occured updating numberOfPublications");
                    }
                    else
                    {
                        console.info("Update of numberOfPublications finished at "+(new Date()).toISOString());
                    }
                });
        }
    );
};


var checkLastUpdateDate =  function(callbackUpdate, callbackNoUpdate)
{
    var json = require(__base+"download/en_product1.json");
    var lastUpdateDateFromJSON=json.JDBOR[0].date.substring(0, 10);

    //Connection to DB
    ConnectionProvider.getConnection();
    ConnectionProvider.connect();

    OtherDao.checkLastUpdateDate(lastUpdateDateFromJSON,callbackUpdate,callbackNoUpdate);
};

var getInformationFromJSON = function(diseases, textualinformations)
{
    var json = require(__base+"download/en_product1.json");

    var disorderList = json.JDBOR[0].DisorderList[0].Disorder;

    for(var m =0; m<disorderList.length; m++)
    {
        var disorder=disorderList[m];

        var disease = Object.create(RareDisease);

        var orphanetID= disorder.OrphaNumber;
        var name= disorder.Name[0].label;
        var description="";
        var sourceName="Orphanet";
        var sourceLink=disorder.ExpertLink[0].link;

        for(var i = 0; i < disorder.TextualInformationList.length; i++)
        {
            if(disorder.TextualInformationList[i].count != "0")
            {
                for(var j = 0; j < disorder.TextualInformationList[i].TextualInformation.length; j++)
                {
                    for(var k = 0; k < disorder.TextualInformationList[i].TextualInformation[j].TextSectionList.length; k++)
                    {
                        if(disorder.TextualInformationList[i].TextualInformation[j].TextSectionList[k].count != "0")
                        {
                            var textSection=disorder.TextualInformationList[i].TextualInformation[j].TextSectionList[k].TextSection;
                            for(var l = 0; l < textSection.length; l++)
                            {
                                var textualInformation=Object.create(TextualInformation);
                                var title=textSection[l].TextSectionType[0].Name[0].label;
                                var content=textSection[l].Contents;
                                var id=textSection[l].id;

                                //Init object
                                textualInformation.init(id, title, content, orphanetID, sourceName, sourceLink);

                                textualinformations.push(textualInformation);
                            }
                        }

                    }
                }   
            }

        }

        disease.init(orphanetID, name);
        diseases.push(disease);
    }
};

var getIdsFromSearch = function(searchString, orphanetID, callback)
{
    var pubmed = NcbiApi.dbFactory(NcbiApi.DB.PUBMED)
    pubmed.esearch(
        {
            term: searchString+" AND"+" hasabstract[text]"+" AND"+" Humans[Mesh]",
            retmode: "json",
            retmax:100000
        }, 
        function(err, response, data) 
        {
            if(data != undefined && data.esearchresult != undefined)
            {
                var idlist= data.esearchresult.idlist;
                callback(idlist, orphanetID);
            }
        }
    );
};

var getRareDisease_YearFromIds = function(ids, orphanetID, callback)
{
    var pubmed = NcbiApi.dbFactory(NcbiApi.DB.PUBMED)
    pubmed.esummary(
        {
            ids: ids,
            retmode: "json"
        }, 
        function(err, response, data) 
        {
            if(data != undefined && data.result != undefined)
            {
                var idslist= data.result.uids;
                var rareDisease_YearList=[];

                for(var i = 0; i < idslist.length; i++)
                {
                    var yearString=data.result[idslist[i]].pubdate.substring(0,4);

                    var rareDisease_YearIndex=rareDisease_YearList.findIndex(function(currentValue, index, arr){return currentValue.year == yearString});

                    //Is this date already in the array?
                    if(rareDisease_YearIndex != -1)
                    {
                        rareDisease_YearList[rareDisease_YearIndex].numberOfPublications++;
                    }
                    else
                    {
                        //Create rareDisease_Year object
                        var rareDisease_Year=Object.create(RareDisease_Year);
                        rareDisease_Year.init(
                            yearString,
                            orphanetID,
                            1
                        );
                        //Ajout à la collection
                        rareDisease_YearList.push(rareDisease_Year);
                    }
                }
                callback(rareDisease_YearList);
            }
        }
    );
};

var download = function(url, dest, callback) 
{
    console.log("Download of file "+dest+" start...");
    var file = fs.createWriteStream(dest);
    var request = http.get(url, function(response) {
        response.pipe(file);
        file.on('finish', function() {
            console.log("Download finished");
            file.close(callback);  // close() is async, call cb after close completes.
        });
    }).on('error', function(err) { 
        // Handle errors
        fs.unlink(dest); // Delete the file async. (But we don't check the result)
        if (callback) callback(err.message);
    });
};