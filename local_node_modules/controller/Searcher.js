var request = require("request");
var xml2js = require("xml2js");
const jsdom = require("jsdom");
const { JSDOM } = jsdom;
var async = require("async");
var Publication = require("../model/Publication.js");

var search = function(terms, res, callback)
{
    console.info("Searching publications ids...");
    var url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmax=100&term=("+terms+" AND hasabstract[text] AND Humans[Mesh])&retmode=json"

    request({
        url: url,
        json: true
    }, function (error, response, body)
            {
        if (!error && response.statusCode === 200)
        {
            console.info("Searching publications ids finished");
            console.info("Searching Pubmed details...");

            var idlist= body.esearchresult.idlist;
            var publications=[];

            async.eachLimit(idlist, 10, function (id, next) {
                setTimeout(function() {
                    getDetails(id, publications, next);
                }, 50);
            }, 
            function (err) 
            {
                if(err)
                {
                    console.error("Error occured when searching publications ids");
                }
                else
                {
                    console.info("Searching Pubmed details finished");
                    callback(publications, res);
                }
            });
        }
        else
        {
            console.error("Error occured when searching publications ids, Status: "+response.statusCode);
        }
    });

}

var getDetails = function(id, publications, next)
{
    var url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id="+id+"&rettype=xml";
    request
    (
        {
            url: url,
        },
        function (error2, response2, body2)
        {
            if (!error2 && response2.statusCode === 200)
            {
                try
                {
                    //Conversion vers JS Object dans objectFromXml
                    var objectFromXml="";
                    var parser = new xml2js.Parser();
                    parser.parseString
                    (
                        body2,
                        function (err, result)
                        {
                            objectFromXml = result;
                        }
                    );

                    //Article Title search
                    var title=objectFromXml.PubmedArticleSet.PubmedArticle[0].MedlineCitation[0].Article[0].ArticleTitle[0];

                    //Abstract Search
                    var abstract="";
                    var objectAbstract=objectFromXml.PubmedArticleSet.PubmedArticle[0].MedlineCitation[0].Article[0].Abstract[0].AbstractText;
                    if(objectAbstract.length==1)
                    {
                        abstract=objectAbstract[0];
                    }
                    else
                    {
                        for(var j=0; j< objectAbstract.length; j++)
                        {
                            if(objectAbstract[j].$ != undefined)
                            {
                                abstract+=objectAbstract[j].$.Label+" \n";
                                abstract+=objectAbstract[j]._+" \n";
                            }
                            else
                            {
                                abstract+=objectAbstract[j]+" \n";
                            }
                        }
                    }

                    //Authors Search
                    var authors=[];
                    objectAuthors=objectFromXml.PubmedArticleSet.PubmedArticle[0].MedlineCitation[0].Article[0].AuthorList[0].Author;
                    for(var j=0; j< objectAuthors.length; j++)
                    {
                        var author="";
                        if(objectAuthors[j].LastName != undefined && objectAuthors[j].ForeName != undefined)
                        {
                            var author=objectAuthors[j].LastName[0]+" "+objectAuthors[j].ForeName[0];
                        }
                        else if(objectAuthors[j].CollectiveName != undefined)
                        {
                            var author=objectAuthors[j].CollectiveName[0];
                        }
                        authors.push(author);
                    }

                    //DOI Search
                    var doi="";
                    var objectDOI=objectFromXml.PubmedArticleSet.PubmedArticle[0].PubmedData[0].ArticleIdList[0].ArticleId;
                    for(var j=0; j< objectDOI.length; j++)
                    {
                        var idObj=objectDOI[j];
                        if(idObj.$.IdType==="doi")
                        {
                            doi=idObj._;
                        }
                    }

                    //Date Search
                    var date="";
                    var objectDate=objectFromXml.PubmedArticleSet.PubmedArticle[0].MedlineCitation[0].DateRevised[0];
                    date=new Date(objectDate.Year+"-"+objectDate.Month+"-"+objectDate.Day+"T00:00:00");



                    //Création de l'objet publication
                    var publication=Object.create(Publication);
                    publication.init(
                        id,
                        title,
                        abstract,
                        authors,
                        doi,
                        date,
                        ""
                    );

                    //Ajout à la collection
                    publications.push(publication);
                }
                catch(err)
                {
                    console.error("Error occured when converting response from "+url+" to publication object:");
                    console.error(err.message);
                    console.error("\n");
                }

            }
            else
            {
                console.error("Error occured when searching Pubmed details, Status: "+response2.statusCode);
            }
            next();
        }
    );
}

var getURL = function(publications, completedRequestsObject, length)
{
    completedRequestsObject.completedRequests = 0;
    for(var i =0; i< publications.length; i++)
    {
        var url = "https://scholar.google.com/scholar?q=http://dx.doi.org/"+publications[i].doi;
        var url2 = "https://scholar.google.ca/intl/fr/scholar/about.html";
        request(
            {
                url: url2
            },
            function (error, response, body)
            {
                if (!error && response.statusCode === 200)
                {
                    const dom = new JSDOM(body);
                    const { document } = dom.window;
                    var link= document.querySelector("#gs_ggsW0 > div > a");
                    if(link!=null && link!= undefined)
                    {
                        //Link for PDF found
                        publications[i].url=link;
                    }

                    completedRequestsObject.completedRequests++;
                    if(completedRequestsObject.completedRequests == length)
                    {
                        console.info("Searching urls on Google Scholar finished");
                    }

                }
                else
                {
                    console.error("Error occured when searching urls on Google Scholar, Status: "+response.statusCode);
                }
            });
    }
}

exports.search= search;