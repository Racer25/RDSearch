global.lastUpdateDateFromJSON_GLOBAL="";

var ConnectionProvider=require("./ConnectionProvider");
var mysql = require('mysql');


var checkLastUpdateDate = function(lastUpdateDateFromJSON, callbackUpdate, callbackNoUpdate)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT lastUpdateDate FROM other";
    
    lastUpdateDateFromJSON_GLOBAL=lastUpdateDateFromJSON;

    connection.query(sql, function (error, results, fields) {
            if (error) throw error;

            console.log("DB: "+results[0].lastUpdateDate+", JSON: "+lastUpdateDateFromJSON_GLOBAL);

            var lastUpdateDateFromDB=new Date(Date.parse(results[0].lastUpdateDate));
            var lastUpdateDateFromJSON_DATE=new Date(Date.parse(lastUpdateDateFromJSON_GLOBAL));

            if(lastUpdateDateFromDB ==undefined || lastUpdateDateFromDB ==null || lastUpdateDateFromJSON_DATE > lastUpdateDateFromDB)
            {
                console.log("Update found");
                updateLastUpdateDate(lastUpdateDateFromJSON_GLOBAL);
                callbackUpdate();
            }
            else
            {
                console.log("No update found");
                callbackNoUpdate();
            }
        }
    );
    
};

var updateLastUpdateDate = function(lastUpdateDateFromJSON)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "INSERT INTO other(idOther, lastUpdateDate) VALUES(1, ?) ON DUPLICATE KEY UPDATE lastUpdateDate=?";
    var inserts = [lastUpdateDateFromJSON, lastUpdateDateFromJSON];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
    });
};

exports.checkLastUpdateDate=checkLastUpdateDate;
exports.updateLastUpdateDate=updateLastUpdateDate;