var ConnectionProvider = require("../dao/ConnectionProvider.js");
var mysql = require('mysql');

var addOrModifyRareDisease = function(rareDisease, callback)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "INSERT INTO rareDisease(orphanetID, name) "+
        "VALUES(?, ?) ON DUPLICATE KEY "+ 
        "UPDATE name=?";
    var inserts = [rareDisease.orphanetID, rareDisease.name, rareDisease.name];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback();
    });
};

var getRareDiseaseByName = function(name, callback)
{    
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM rareDisease WHERE BINARY name=?";
    var inserts = [name];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results);
    });
};

var getRareDiseaseByOrphanetID = function(orphanetID, callback)
{    
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM rareDisease WHERE orphanetID=?";
    var inserts = [orphanetID];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results[0]);
    });
};

var getRareDiseasesSuggestions = function(terms, callback)
{    
    if (terms.length !=0)
    {
        var connection=ConnectionProvider.getConnection();

        //Construction of the end of request
        var stringToConcat="";
        for(var i=0; i < terms.length; i++)
        {
            if(i==0)
            {
                stringToConcat+= " name LIKE ?";
            }
            else
            {
                stringToConcat+= " OR name LIKE ?";
            }
        }

        //Construction of inserts
        var inserts=[];
        for(var i=0; i < terms.length; i++)
        {
            inserts.push("%"+terms[i]+"%");
        }
        var sql = "SELECT * FROM rareDisease WHERE"+ stringToConcat;
        
        //Final construction of request
        sql = mysql.format(sql, inserts);

        //Lanch request
        connection.query(sql, function (error, results, fields) {
            if (error) throw error;
            callback(results);
        });
    }
    else
    {
        callback([]);
    }
};

var getRareDiseases = function(callback)
{    
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM rareDisease";
    var inserts = [];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results);
    });
};

exports.getRareDiseaseByName=getRareDiseaseByName;
exports.getRareDiseaseByOrphanetID=getRareDiseaseByOrphanetID;
exports.getRareDiseasesSuggestions=getRareDiseasesSuggestions;
exports.addOrModifyRareDisease=addOrModifyRareDisease;
exports.getRareDiseases=getRareDiseases;