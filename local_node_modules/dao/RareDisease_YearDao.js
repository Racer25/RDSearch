var ConnectionProvider = require("../dao/ConnectionProvider.js");
var mysql = require('mysql');

var getRareDisease_Year = function(yearString, orphanetID,  callback)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM is_studied_during WHERE year=? AND orphanetID=?";
    var inserts = [yearString, orphanetID];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results);
    });
}

var getRareDisease_YearByOrphanetID = function(orphanetID,  callback)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM is_studied_during WHERE orphanetID=?";
    var inserts = [orphanetID];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results);
    });
}

var getTop3RareDisease_Year = function(year, limit, callback)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "SELECT * FROM is_studied_during WHERE year=? ORDER BY numberOfPublications DESC LIMIT ?";
    var inserts = [year, limit];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback(results);
    });
}

var addOrModifyRareDisease_Year = function(rareDisease_Year, callback)
{
    var connection=ConnectionProvider.getConnection();

    var sql = "INSERT INTO is_studied_during(year, orphanetID, numberOfPublications) "+
        "VALUES(?, ?, ?) ON DUPLICATE KEY "+ 
        "UPDATE numberOfPublications=?";
    var inserts = [rareDisease_Year.year, rareDisease_Year.orphanetID, rareDisease_Year.numberOfPublications, rareDisease_Year.numberOfPublications];
    sql = mysql.format(sql, inserts);

    connection.query(sql, function (error, results, fields) {
        if (error) throw error;
        callback();
    });
}

var addOrModifyRareDisease_Years = function(rareDisease_Years)
{    
    console.log("Launching addOrModifyRareDisease_YearsRequest");
    for(var i = 0; i < rareDisease_Years.length; i++)
    {
        addOrModifyRareDisease_Year(rareDisease_Years[i]);
    }
}


exports.getRareDisease_Year=getRareDisease_Year;
exports.getTop3RareDisease_Year=getTop3RareDisease_Year;
exports.getRareDisease_YearByOrphanetID=getRareDisease_YearByOrphanetID;
exports.addOrModifyRareDisease_Year=addOrModifyRareDisease_Year;
exports.addOrModifyRareDisease_Years=addOrModifyRareDisease_Years;